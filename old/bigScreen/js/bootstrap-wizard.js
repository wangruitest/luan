(function(b){b.fn.wizard=function(c){return new Wizard(this,c)};b.fn.wizard.logging=false;var a=function(g,d,c,f,e){this.wizard=g;this.index=c;this.prev=f;this.next=e;this.el=d;this.title=d.find("h3").first().text();this.name=d.data("cardname")||this.title;this.nav=this._createNavElement(this.title,c);this._disabled=false;this._loaded=false;this._events={}};a.prototype={select:function(){this.log("selecting");if(!this.isSelected()){this.nav.addClass("active");this.el.show();if(!this._loaded){this.trigger("loaded");this.reload()}this.trigger("selected")}var c=this.wizard;c.backButton.toggleClass("disabled",this.index==0);if(this.index>=c._cards.length-1){this.log("on last card, changing next button to submit");c.changeNextButton(c.args.buttons.submitText,"btn-success");c._readyToSubmit=true;c.trigger("readySubmit")}else{c._readyToSubmit=false;c.changeNextButton(c.args.buttons.nextText,"btn-primary")}return this},_createNavElement:function(e,f){var c=b('<li class="wizard-nav-item"></li>');var d=b('<a class="wizard-nav-link"></a>');d.data("navindex",f);c.append(d);d.append('<i class="icon-chevron-right"></i>');d.append(e);return c},markVisited:function(){this.log("marking as visited");this.nav.addClass("already-visited");this.trigger("markVisited");return this},unmarkVisited:function(){this.log("unmarking as visited");this.nav.removeClass("already-visited");this.trigger("unmarkVisited");return this},deselect:function(){this.nav.removeClass("active");this.el.hide();this.trigger("deselect");return this},enable:function(){this.log("enabling");this.nav.addClass("active");this._disabled=false;this.trigger("enabled");return this},disable:function(c){this.log("disabling");this._disabled=true;this.nav.removeClass("active already-visited");if(c){this.el.hide()}this.trigger("disabled");return this},isDisabled:function(){return this._disabled},alreadyVisited:function(){return this.nav.hasClass("already-visited")},isSelected:function(){return this.nav.hasClass("active")},reload:function(){this._loaded=true;this.trigger("reload");return this},on:function(){return this.wizard.on.apply(this,arguments)},trigger:function(){this.callListener("on"+arguments[0]);return this.wizard.trigger.apply(this,arguments)},toggleAlert:function(e,c){this.log("toggling alert to: "+c);c=typeof(c)=="undefined"?true:c;if(c){this.trigger("showAlert")}else{this.trigger("hideAlert")}var f;var d=this.el.children("h3").first().next("div.alert");if(d.length==0){if(!c){return this}this.log("couldn't find existing alert div, creating one");f=b("<div />");f.addClass("alert");f.addClass("hide");f.insertAfter(this.el.find("h3").first())}else{this.log("found existing alert div");f=d.first()}if(c){if(e!=null){this.log("setting alert msg to",e);f.html(e)}f.show()}else{f.hide()}return this},callListener:function(d){d=d.toLowerCase();this.log("looking for listener "+d);var g=window[this.el.data(d)];if(g){this.log("calling listener "+d);var f=this.wizard;try{var c=g(this)}catch(h){this.log("exception calling listener "+d+": ",h)}}else{this.log("didn't find listener "+d)}},problem:function(c){this.nav.find("a").toggleClass("wizard-step-error",c)},validate:function(){var f=false;var e=this;this.el.find("[data-validate]").each(function(m,n){e.log("validating individiual inputs");n=b(n);var k=n.data("validate");if(!k){return}var l={status:true,title:"Error",msg:""};var j=window[k](n);b.extend(l,j);if(!l.status){f=true;n.parent(".control-group").toggleClass("error",true);e.wizard.errorPopover(n,l.msg)}else{n.parent(".control-group").toggleClass("error",false);try{n.popover("destroy")}catch(o){n.popover("hide")}}});this.log("after validating inputs, failures is",f);var d=window[this.el.data("validate")];if(d){this.log("running html-embedded card validator");var g=d(this);if(typeof(g)=="undefined"||g==null){g=true}if(!g){f=true}this.log("after running html-embedded card validator, failures is",f)}this.log("running listener validator");var c=this.trigger("validate");if(typeof(c)=="undefined"||c==null){c=true}if(!c){f=true}this.log("after running listener validator, failures is",f);var h=!f;if(h){this.log("validated, calling listeners");this.trigger("validated")}else{this.log("invalid");this.trigger("invalid")}return h},log:function(){if(!window.console||!b.fn.wizard.logging){return}var c="card '"+this.name+"': ";var d=[c];d.push.apply(d,arguments);console.log.apply(console,d)},isActive:function(){return this.nav.hasClass("active")}};Wizard=function(e,f){var j=['<div class="modal wizard-modal" role="dialog">','<div class="wizard-modal-header modal-header">','<button class="wizard-close close" type="button">x</button>','<h3 class="wizard-title"></h3>','<span class="wizard-subtitle"></span>',"</div>",'<div class="pull-left wizard-steps">','<div class="wizard-nav-container">','<ul class="nav nav-list" style="padding-bottom:30px;">',"</ul>","</div>",'<div class="wizard-progress-container">','<div class="progress progress-striped">','<div class="progress-bar progress-bar-primary" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">','<span class="sr-only">0% Complete</span>',"</div>","</div>","</div>","</div>","<form>",'<div class="wizard-cards">','<div class="wizard-card-container">',"</div>",'<div class="wizard-modal-footer">','<div class="wizard-buttons-container">','<button class="btn wizard-cancel wizard-close" type="button">Cancel</button>','<div class="btn-group-single pull-right">','<button class="btn wizard-back" type="button">Back</button>','<button class="btn btn-primary wizard-next" type="button">Next</button>',"</div>","</div>","</div>","</div>","</form>","</div>"];this.args={submitUrl:"",width:750,showCancel:false,progressBarCurrent:false,increaseHeight:0,buttons:{cancelText:"Cancel",nextText:"Next",backText:"Back",submitText:"Submit",submittingText:"Submitting...",}};b.extend(this.args,f||{});this.markup=b(e);this.submitCards=this.markup.find(".wizard-error,.wizard-failure,.wizard-success,.wizard-loading");this.el=b(j.join("\n"));this.el.find(".wizard-card-container").append(this.markup.find(".wizard-card")).append(this.submitCards);b("body").append(this.el);this.closeButton=this.el.find("button.wizard-close");this.footer=this.el.find(".wizard-modal-footer");this.cancelButton=this.footer.find(".wizard-cancel");this.backButton=this.footer.find(".wizard-back");this.nextButton=this.footer.find(".wizard-next");this.progress=this.el.find(".progress");this._cards=[];this.cards={};this._readyToSubmit=false;this.percentComplete=0;this._submitting=false;this._events={};this._firstShow=true;this._createCards();this.nextButton.click(this,this._handleNextClick);this.backButton.click(this,this._handleBackClick);this.cancelButton.text(this.args.buttons.cancelText);this.backButton.text(this.args.buttons.backText);this.nextButton.text(this.args.buttons.nextText);var c=360;var i=c+this.args.increaseHeight;this.el.find(".wizard-nav-container").css("height",i);this.el.find(".wizard-steps").css("height",(i+65)+"px");this.el.find(".wizard-card").css("height",(i-60)+"px");this.submitCards.css("height",(i-60)+"px");this.el.css("margin-top",-(this.el.height()/2));this.el.css("width",this.args.width);this.el.css("margin-left",-(this.args.width/2));if(b.fn.slimScroll&&false){var g={position:"left",height:"360px",size:"8px",distance:"5px",railVisible:true,disableFadeOut:true,};b.extend(g,this.args.slimScroll||{});this.el.find(".wizard-nav-container").slimScroll(g)}var d=this;this.closeButton.click(function(){d.reset();d.close();d.trigger("closed")});this.el.find(".wizard-steps").on("click","li.already-visited a.wizard-nav-link",this,function(l){var k=parseInt(b(l.target).data("navindex"));l.data.setCard(k)});var h=this.markup.children("h1").first();if(h.length){this.setTitle(h.text())}this.on("submit",this._defaultSubmit)};Wizard.prototype={errorPopover:function(c,e){this.log("launching popover on",c);var d=c.popover({content:e,placement:"top",trigger:"manual"}).popover("show").next(".popover");d.addClass("error-popover");return d},destroyPopover:function(c){c=b(c);c.parent(".control-group").toggleClass("error",false);var d=c.prev();try{d.popover("destroy")}catch(f){d.popover("hide")}},hidePopovers:function(d){this.log("hiding all popovers");var c=this;this.el.find(".error-popover").each(function(e,f){c.destroyPopover(f)})},eachCard:function(c){b.each(this._cards,c);return this},getActiveCard:function(){this.log("getting active card");var c=null;b.each(this._cards,function(e,d){if(d.isActive()){c=d;return false}});if(c){this.log("found active card",c)}else{this.log("couldn't find an active card")}return c},setTitle:function(c){this.log("setting title to",c);this.el.find(".wizard-title").first().text(c);return this},setSubtitle:function(c){this.log("setting subtitle to",c);this.el.find(".wizard-subtitle").first().text(c);return this},changeNextButton:function(d,c){this.log("changing next button, text: "+d,"class: "+c);if(typeof(c)!="undefined"){this.nextButton.removeClass("btn-success btn-primary")}if(c){this.nextButton.addClass(c)}this.nextButton.text(d);return this},hide:function(){this.log("hiding");this.el.modal("hide");return this},close:function(){this.log("closing");this.el.modal("hide");return this},show:function(c){this.log("showing");if(this._firstShow){this.setCard(0);this._firstShow=false}if(this.args.showCancel){this.cancelButton.show()}this.el.modal(c);return this},on:function(c,d){this.log("adding listener to event "+c);this._events[c]=d;return this},trigger:function(){var f=arguments[0];var d=Array.prototype.slice.call(arguments);d.shift();d.unshift(this);this.log("firing event "+f);var g=this._events[f];var c=null;if(typeof(g)=="function"){this.log("found event handler, calling "+f);try{c=g.apply(this,d)}catch(h){this.log("event handler "+f+" had an exception")}}else{this.log("couldn't find an event handler for "+f)}return c},reset:function(){this.log("resetting");this.updateProgressBar(0);this.hideSubmitCards();this.setCard(0);this.lockCards();this.enableNextButton();this.showButtons();this.hidePopovers();this.trigger("reset");return this},log:function(){if(!window.console||!b.fn.wizard.logging){return}var c="wizard "+this.el.id+": ";var d=[c];d.push.apply(d,arguments);console.log.apply(console,d)},_abstractIncrementStep:function(e,f){var d=this.getActiveCard();var c;if(d){this.log("searching for valid next card");while(true){c=f(d);if(c){this.log("looking at card",c.index);if(c.isDisabled()){this.log("card "+c.index+" is disabled/locked, continuing");d=c;continue}else{return this.setCard(d.index+e)}}else{this.log("next card is not defined, breaking");break}}}else{this.log("current card is undefined")}},incrementCard:function(){this.log("incrementing card");var c=this._abstractIncrementStep(1,function(d){return d.next});this.trigger("incrementCard");return c},decrementCard:function(){this.log("decrementing card");var c=this._abstractIncrementStep(-1,function(d){return d.prev});this.trigger("decrementCard");return c},setCard:function(h){this.log("setting card to "+h);this.hideSubmitCards();var e=this.getActiveCard();if(this._submitting){this.log("we're submitting the wizard already, can't change cards");return e}var d=this._cards[h];if(d){if(d.isDisabled()){this.log("new card is currently disabled, returning");return e}if(e){if(h>e.index){var f=e;var g=false;while(f.index!=d.index){if(f.index!=e.index){f.prev.deselect();f.prev.markVisited();f.select()}g=f.validate();if(!g){return f}f=f.next}f.prev.deselect();f.prev.markVisited()}e.deselect();e.markVisited()}d.select();if(this.args.progressBarCurrent){this.percentComplete=h*100/this._cards.length;this.updateProgressBar(this.percentComplete)}else{var c=this.percentComplete;this.percentComplete=h*100/this._cards.length;this.percentComplete=Math.max(c,this.percentComplete);this.updateProgressBar(this.percentComplete)}return d}else{this.log("couldn't find card "+h)}},updateProgressBar:function(c){this.log("updating progress to "+c+"%");var d=this.progress.find(".progress-bar");d.css({width:c+"%"});d.find(".sr-only").html(parseInt(c)+"% Complete");d.attr("aria-valuenow",parseInt(c));this.percentComplete=c;this.trigger("progressBar",c);if(c==100){this.log("progress is 100, animating progress bar");this.progress.addClass("active")}else{if(c==0){this.log("progress is 0, disabling animation");this.progress.removeClass("active")}}},getNextCard:function(){var c=this.getActiveCard();if(c){return c.next}},lockCards:function(){this.log("locking nav cards");this.eachCard(function(d,c){c.unmarkVisited()});return this},disableCards:function(){this.log("disabling all nav cards");this.eachCard(function(d,c){c.disable()});return this},enableCards:function(){this.log("enabling all nav cards");this.eachCard(function(d,c){c.enable()});return this},hideCards:function(){this.log("hiding cards");this.eachCard(function(d,c){c.deselect()});this.hideSubmitCards();return this},hideButtons:function(){this.log("hiding buttons");this.cancelButton.hide();this.nextButton.hide();this.backButton.hide();return this},showButtons:function(){this.log("showing buttons");if(this.args.showCancel){this.cancelButton.show()}this.nextButton.show();this.backButton.show();return this},getCard:function(d){var c=b(d).parents(".wizard-card").first()[0];if(c){var e=null;this.eachCard(function(g,f){if(c==f.el[0]){e=f;return false}return true});return e}else{return null}},_createCards:function(){var f=null;var e=null;var c=null;var g=this;var d=this;var h=this.el.find(".wizard-cards .wizard-card");b.each(h,function(k,j){j=b(j);f=c;c=new a(g,j,k,f,e);d._cards.push(c);if(c.name){d.cards[c.name]=c}if(f){f.next=c}d.el.find(".wizard-steps .nav-list").append(c.nav)})},showSubmitCard:function(d){this.log("showing "+d+" submit card");var c=this.el.find(".wizard-"+d);if(c.length){this.hideCards();this.el.find(".wizard-"+d).show()}else{this.log("couldn't find submit card "+d)}},hideSubmitCard:function(c){this.log("hiding "+c+" submit card");this.el.find(".wizard-"+c).hide()},hideSubmitCards:function(){var c=this;b.each(["success","error","failure","loading"],function(e,d){c.hideSubmitCard(d)})},enableNextButton:function(){this.log("enabling next button");this.nextButton.removeAttr("disabled");return this},disableNextButton:function(){this.log("disabling next button");this.nextButton.attr("disabled","disabled");return this},serializeArray:function(){var c=this.el.children("form").first();return c.serializeArray()},serialize:function(){var c=this.el.children("form").first();return c.serialize()},submitSuccess:function(){this.log("submit success");this._submitting=false;this.showSubmitCard("success");this.trigger("submitSuccess")},submitFailure:function(){this.log("submit failure");this._submitting=false;this.showSubmitCard("failure");this.trigger("submitFailure")},submitError:function(){this.log("submit error");this._submitting=false;this.showSubmitCard("error");this.trigger("submitError")},_submit:function(){this.log("submitting wizard");this._submitting=true;this.lockCards();this.cancelButton.hide();this.backButton.hide();this.showSubmitCard("loading");this.updateProgressBar(100);this.changeNextButton(this.args.buttons.submittingText,false);this.disableNextButton();var c=this.trigger("submit");this.trigger("loading")},_onNextClick:function(){this.log("handling 'next' button click");var c=this.getActiveCard();if(this._readyToSubmit&&c.validate()){this._submit()}else{c=this.incrementCard()}},_onBackClick:function(){this.log("handling 'back' button click");var c=this.decrementCard()},_handleNextClick:function(c){var d=c.data;d._onNextClick.call(d)},_handleBackClick:function(c){var d=c.data;d._onBackClick.call(d)},_defaultSubmit:function(c){b.ajax({type:"POST",url:c.args.submitUrl,data:c.serialize(),dataType:"json",success:function(d){c.submitSuccess();c.hideButtons();c.updateProgressBar(0)},error:function(){c.submitFailure();c.hideButtons()},})}}}(window.jQuery));