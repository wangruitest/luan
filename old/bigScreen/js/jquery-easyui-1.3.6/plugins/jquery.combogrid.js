(function(d){function e(m){var l=d.data(m,"combogrid");var k=l.options;var j=l.grid;d(m).addClass("combogrid-f").combo(k);var h=d(m).combo("panel");if(!j){j=d("<table></table>").appendTo(h);l.grid=j}j.datagrid(d.extend({},k,{border:false,fit:true,singleSelect:(!k.multiple),onLoadSuccess:function(p){var o=d(m).combo("getValues");var n=k.onSelect;k.onSelect=function(){};b(m,o,l.remainText);k.onSelect=n;k.onLoadSuccess.apply(m,arguments)},onClickRow:i,onSelect:function(o,n){g();k.onSelect.call(this,o,n)},onUnselect:function(n,o){g();k.onUnselect.call(this,n,o)},onSelectAll:function(n){g();k.onSelectAll.call(this,n)},onUnselectAll:function(n){if(k.multiple){g()}k.onUnselectAll.call(this,n)}}));function i(n,o){l.remainText=false;g();if(!k.multiple){d(m).combo("hidePanel")}k.onClickRow.call(this,n,o)}function g(){var q=j.datagrid("getSelections");var p=[],o=[];for(var n=0;n<q.length;n++){p.push(q[n][k.idField]);o.push(q[n][k.textField])}if(!k.multiple){d(m).combo("setValues",(p.length?p:[""]))}else{d(m).combo("setValues",p)}if(!l.remainText){d(m).combo("setText",o.join(k.separator))}}}function f(m,j){var l=d.data(m,"combogrid");var k=l.options;var i=l.grid;var h=i.datagrid("getRows").length;if(!h){return}var n=k.finder.getTr(i[0],null,"highlight");if(!n.length){n=k.finder.getTr(i[0],null,"selected")}var g;if(!n.length){g=(j=="next"?0:h-1)}else{var g=parseInt(n.attr("datagrid-row-index"));g+=(j=="next"?1:-1);if(g<0){g=h-1}if(g>=h){g=0}}i.datagrid("highlightRow",g);if(k.selectOnNavigation){l.remainText=false;i.datagrid("selectRow",g)}}function b(p,o,n){var m=d.data(p,"combogrid");var l=m.options;var k=m.grid;var j=k.datagrid("getRows");var v=[];var h=d(p).combo("getValues");var g=d(p).combo("options");var u=g.onChange;g.onChange=function(){};k.datagrid("clearSelections");for(var q=0;q<o.length;q++){var r=k.datagrid("getRowIndex",o[q]);if(r>=0){k.datagrid("selectRow",r);v.push(j[r][l.textField])}else{v.push(o[q])}}d(p).combo("setValues",h);g.onChange=u;d(p).combo("setValues",o);if(!n){var t=v.join(l.separator);if(d(p).combo("getText")!=t){d(p).combo("setText",t)}}}function c(j,m){var i=d.data(j,"combogrid");var h=i.options;var l=i.grid;i.remainText=true;if(h.multiple&&!m){b(j,[],true)}else{b(j,[m],true)}if(h.mode=="remote"){l.datagrid("clearSelections");l.datagrid("load",d.extend({},h.queryParams,{q:m}))}else{if(!m){return}l.datagrid("clearSelections").datagrid("highlightRow",-1);var k=l.datagrid("getRows");var g=h.multiple?m.split(h.separator):[m];d.map(g,function(n){n=d.trim(n);if(n){d.map(k,function(p,o){if(n==p[h.textField]){l.datagrid("selectRow",o)}else{if(h.filter.call(j,n,p)){l.datagrid("highlightRow",o)}}})}})}}function a(k){var j=d.data(k,"combogrid");var h=j.options;var i=j.grid;var m=h.finder.getTr(i[0],null,"highlight");j.remainText=false;if(m.length){var g=parseInt(m.attr("datagrid-row-index"));if(h.multiple){if(m.hasClass("datagrid-row-selected")){i.datagrid("unselectRow",g)}else{i.datagrid("selectRow",g)}}else{i.datagrid("selectRow",g)}}var l=[];d.map(i.datagrid("getSelections"),function(n){l.push(n[h.idField])});d(k).combogrid("setValues",l);if(!h.multiple){d(k).combogrid("hidePanel")}}d.fn.combogrid=function(h,g){if(typeof h=="string"){var i=d.fn.combogrid.methods[h];if(i){return i(this,g)}else{return this.combo(h,g)}}h=h||{};return this.each(function(){var j=d.data(this,"combogrid");if(j){d.extend(j.options,h)}else{j=d.data(this,"combogrid",{options:d.extend({},d.fn.combogrid.defaults,d.fn.combogrid.parseOptions(this),h)})}e(this)})};d.fn.combogrid.methods={options:function(h){var g=h.combo("options");return d.extend(d.data(h[0],"combogrid").options,{originalValue:g.originalValue,disabled:g.disabled,readonly:g.readonly})},grid:function(g){return d.data(g[0],"combogrid").grid},setValues:function(h,g){return h.each(function(){b(this,g)})},setValue:function(h,g){return h.each(function(){b(this,[g])})},clear:function(g){return g.each(function(){d(this).combogrid("grid").datagrid("clearSelections");d(this).combo("clear")})},reset:function(g){return g.each(function(){var h=d(this).combogrid("options");if(h.multiple){d(this).combogrid("setValues",h.originalValue)}else{d(this).combogrid("setValue",h.originalValue)}})}};d.fn.combogrid.parseOptions=function(h){var g=d(h);return d.extend({},d.fn.combo.parseOptions(h),d.fn.datagrid.parseOptions(h),d.parser.parseOptions(h,["idField","textField","mode"]))};d.fn.combogrid.defaults=d.extend({},d.fn.combo.defaults,d.fn.datagrid.defaults,{loadMsg:null,idField:null,textField:null,mode:"local",keyHandler:{up:function(g){f(this,"prev");g.preventDefault()},down:function(g){f(this,"next");g.preventDefault()},left:function(g){},right:function(g){},enter:function(g){a(this)},query:function(g,h){c(this,g)}},filter:function(g,i){var h=d(this).combogrid("options");return i[h.textField].toLowerCase().indexOf(g.toLowerCase())==0}})})(jQuery);