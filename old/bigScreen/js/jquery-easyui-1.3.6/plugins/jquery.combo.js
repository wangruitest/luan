(function(k){function m(D,C){var A=k.data(D,"combo");var y=A.options;var x=A.combo;var w=A.panel;if(C){y.width=C}if(isNaN(y.width)){var z=k(D).clone();z.css("visibility","hidden");z.appendTo("body");y.width=z.outerWidth();z.remove()}x.appendTo("body");var v=x.find("input.combo-text");var u=x.find(".combo-arrow");var B=y.hasDownArrow?u._outerWidth():0;x._outerWidth(y.width)._outerHeight(y.height);v._outerWidth(x.width()-B);v.css({height:x.height()+"px",lineHeight:x.height()+"px"});u._outerHeight(x.height());w.panel("resize",{width:(y.panelWidth?y.panelWidth:x.outerWidth()),height:y.panelHeight});x.insertAfter(D)}function l(w){k(w).addClass("combo-f").hide();var v=k('<span class="combo"><input type="text" class="combo-text" autocomplete="off"><span><span class="combo-arrow"></span></span><input type="hidden" class="combo-value"></span>').insertAfter(w);var u=k('<div class="combo-panel"></div>').appendTo("body");u.panel({doSize:false,closed:true,cls:"combo-p",style:{position:"absolute",zIndex:10},onOpen:function(){var y=k(this).panel("panel");if(k.fn.menu){y.css("z-index",k.fn.menu.defaults.zIndex++)}else{if(k.fn.window){y.css("z-index",k.fn.window.defaults.zIndex++)}}k(this).panel("resize")},onBeforeClose:function(){h(this)},onClose:function(){var y=k.data(w,"combo");if(y){y.options.onHidePanel.call(w)}}});var x=k(w).attr("name");if(x){v.find("input.combo-value").attr("name",x);k(w).removeAttr("name").attr("comboName",x)}return{combo:v,panel:u}}function i(x){var w=k.data(x,"combo");var v=w.options;var u=w.combo;if(v.hasDownArrow){u.find(".combo-arrow").show()}else{u.find(".combo-arrow").hide()}d(x,v.disabled);c(x,v.readonly)}function a(u){var w=k.data(u,"combo");var v=w.combo.find("input.combo-text");v.validatebox("destroy");w.panel.panel("destroy");w.combo.remove();k(u).remove()}function h(u){k(u).find(".combo-f").each(function(){var v=k(this).combo("panel");if(v.is(":visible")){v.panel("close")}})}function e(v){var w=k.data(v,"combo");var u=w.options;var B=w.panel;var A=w.combo;var z=A.find(".combo-text");var y=A.find(".combo-arrow");k(document).unbind(".combo").bind("mousedown.combo",function(D){var C=k(D.target).closest("span.combo,div.combo-p");if(C.length){h(C);return}k("body>div.combo-p>div.combo-panel:visible").panel("close")});z.unbind(".combo");y.unbind(".combo");if(!u.disabled&&!u.readonly){z.bind("click.combo",function(D){if(!u.editable){x.call(this)}else{var C=k(this).closest("div.combo-panel");k("div.combo-panel:visible").not(B).not(C).panel("close")}}).bind("keydown.combo paste.combo drop.combo",function(C){switch(C.keyCode){case 38:u.keyHandler.up.call(v,C);break;case 40:u.keyHandler.down.call(v,C);break;case 37:u.keyHandler.left.call(v,C);break;case 39:u.keyHandler.right.call(v,C);break;case 13:C.preventDefault();u.keyHandler.enter.call(v,C);return false;case 9:case 27:o(v);break;default:if(u.editable){if(w.timer){clearTimeout(w.timer)}w.timer=setTimeout(function(){var D=z.val();if(w.previousValue!=D){w.previousValue=D;k(v).combo("showPanel");u.keyHandler.query.call(v,z.val(),C);k(v).combo("validate")}},u.delay)}}});y.bind("click.combo",function(){x.call(this)}).bind("mouseenter.combo",function(){k(this).addClass("combo-arrow-hover")}).bind("mouseleave.combo",function(){k(this).removeClass("combo-arrow-hover")})}function x(){if(B.is(":visible")){o(v)}else{var C=k(this).closest("div.combo-panel");k("div.combo-panel:visible").not(B).not(C).panel("close");k(v).combo("showPanel")}z.focus()}}function n(w){var A=k.data(w,"combo");var z=A.options;var y=A.combo;var x=A.panel;x.panel("move",{left:v(),top:u()});if(x.panel("options").closed){x.panel("open");z.onShowPanel.call(w)}(function(){if(x.is(":visible")){x.panel("move",{left:v(),top:u()});setTimeout(arguments.callee,200)}})();function v(){var B=y.offset().left;if(z.panelAlign=="right"){B+=y._outerWidth()-x._outerWidth()}if(B+x._outerWidth()>k(window)._outerWidth()+k(document).scrollLeft()){B=k(window)._outerWidth()+k(document).scrollLeft()-x._outerWidth()}if(B<0){B=0}return B}function u(){var B=y.offset().top+y._outerHeight();if(B+x._outerHeight()>k(window)._outerHeight()+k(document).scrollTop()){B=y.offset().top-x._outerHeight()}if(B<k(document).scrollTop()){B=y.offset().top+y._outerHeight()}return B}}function o(v){var u=k.data(v,"combo").panel;u.panel("close")}function s(w){var v=k.data(w,"combo").options;var u=k(w).combo("textbox");u.validatebox(k.extend({},v,{deltaX:(v.hasDownArrow?v.deltaX:(v.deltaX>0?1:-1))}))}function d(w,v){var u=k.data(w,"combo");var y=u.options;var x=u.combo;if(v){y.disabled=true;k(w).attr("disabled",true);x.find(".combo-value").attr("disabled",true);x.find(".combo-text").attr("disabled",true)}else{y.disabled=false;k(w).removeAttr("disabled");x.find(".combo-value").removeAttr("disabled");x.find(".combo-text").removeAttr("disabled")}}function c(y,x){var w=k.data(y,"combo");var u=w.options;u.readonly=x==undefined?true:x;var v=u.readonly?true:(!u.editable);w.combo.find(".combo-text").attr("readonly",v).css("cursor",v?"pointer":"")}function j(x){var w=k.data(x,"combo");var v=w.options;var u=w.combo;if(v.multiple){u.find("input.combo-value").remove()}else{u.find("input.combo-value").val("")}u.find("input.combo-text").val("")}function f(v){var u=k.data(v,"combo").combo;return u.find("input.combo-text").val()}function b(u,x){var w=k.data(u,"combo");var v=w.combo.find("input.combo-text");if(v.val()!=x){v.val(x);k(u).combo("validate");w.previousValue=x}}function g(v){var w=[];var u=k.data(v,"combo").combo;u.find("input.combo-value").each(function(){w.push(k(this).val())});return w}function r(E,D){var C=k.data(E,"combo").options;var B=g(E);var A=k.data(E,"combo").combo;A.find("input.combo-value").remove();var z=k(E).attr("comboName");for(var x=0;x<D.length;x++){var y=k('<input type="hidden" class="combo-value">').appendTo(A);if(z){y.attr("name",z)}y.val(D[x])}var w=[];for(var x=0;x<B.length;x++){w[x]=B[x]}var u=[];for(var x=0;x<D.length;x++){for(var v=0;v<w.length;v++){if(D[x]==w[v]){u.push(D[x]);w.splice(v,1);break}}}if(u.length!=D.length||D.length!=B.length){if(C.multiple){C.onChange.call(E,D,B)}else{C.onChange.call(E,D[0],B[0])}}}function q(v){var u=g(v);return u[0]}function p(v,u){r(v,[u])}function t(w){var v=k.data(w,"combo").options;var u=v.onChange;v.onChange=function(){};if(v.multiple){if(v.value){if(typeof v.value=="object"){r(w,v.value)}else{p(w,v.value)}}else{r(w,[])}v.originalValue=g(w)}else{p(w,v.value);v.originalValue=v.value}v.onChange=u}k.fn.combo=function(w,v){if(typeof w=="string"){var u=k.fn.combo.methods[w];if(u){return u(this,v)}else{return this.each(function(){var x=k(this).combo("textbox");x.validatebox(w,v)})}}w=w||{};return this.each(function(){var x=k.data(this,"combo");if(x){k.extend(x.options,w)}else{var y=l(this);x=k.data(this,"combo",{options:k.extend({},k.fn.combo.defaults,k.fn.combo.parseOptions(this),w),combo:y.combo,panel:y.panel,previousValue:null});k(this).removeAttr("disabled")}i(this);m(this);e(this);s(this);t(this)})};k.fn.combo.methods={options:function(u){return k.data(u[0],"combo").options},panel:function(u){return k.data(u[0],"combo").panel},textbox:function(u){return k.data(u[0],"combo").combo.find("input.combo-text")},destroy:function(u){return u.each(function(){a(this)})},resize:function(v,u){return v.each(function(){m(this,u)})},showPanel:function(u){return u.each(function(){n(this)})},hidePanel:function(u){return u.each(function(){o(this)})},disable:function(u){return u.each(function(){d(this,true);e(this)})},enable:function(u){return u.each(function(){d(this,false);e(this)})},readonly:function(v,u){return v.each(function(){c(this,u);e(this)})},isValid:function(v){var u=k.data(v[0],"combo").combo.find("input.combo-text");return u.validatebox("isValid")},clear:function(u){return u.each(function(){j(this)})},reset:function(u){return u.each(function(){var v=k.data(this,"combo").options;if(v.multiple){k(this).combo("setValues",v.originalValue)}else{k(this).combo("setValue",v.originalValue)}})},getText:function(u){return f(u[0])},setText:function(v,u){return v.each(function(){b(this,u)})},getValues:function(u){return g(u[0])},setValues:function(v,u){return v.each(function(){r(this,u)})},getValue:function(u){return q(u[0])},setValue:function(v,u){return v.each(function(){p(this,u)})}};k.fn.combo.parseOptions=function(v){var u=k(v);return k.extend({},k.fn.validatebox.parseOptions(v),k.parser.parseOptions(v,["width","height","separator","panelAlign",{panelWidth:"number",editable:"boolean",hasDownArrow:"boolean",delay:"number",selectOnNavigation:"boolean"}]),{panelHeight:(u.attr("panelHeight")=="auto"?"auto":parseInt(u.attr("panelHeight"))||undefined),multiple:(u.attr("multiple")?true:undefined),disabled:(u.attr("disabled")?true:undefined),readonly:(u.attr("readonly")?true:undefined),value:(u.val()||undefined)})};k.fn.combo.defaults=k.extend({},k.fn.validatebox.defaults,{width:"auto",height:22,panelWidth:null,panelHeight:200,panelAlign:"left",multiple:false,selectOnNavigation:true,separator:",",editable:true,disabled:false,readonly:false,hasDownArrow:true,value:"",delay:200,deltaX:19,keyHandler:{up:function(u){},down:function(u){},left:function(u){},right:function(u){},enter:function(u){},query:function(u,v){}},onShowPanel:function(){},onHidePanel:function(){},onChange:function(u,v){}})})(jQuery);